<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>LiDAR Ready Particle System
       

    </title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: monospace; }
        canvas { display: block; }

        #ui-panel {
            position: absolute;
            top: 20px; right: 20px;
            width: 300px;
            background: rgba(255, 255, 255, 0.96);
            border: 1px solid #cfcfcf;
            padding: 20px;
            border-radius: 8px;
            color: #111;
        }

        h3 {
            margin: 0 0 15px 0;
            color: #111;
            font-size: 14px;
            text-transform: uppercase;
            border-bottom: 1px solid #d7d7d7;
            padding-bottom: 10px;
        }

        .control-group { margin-bottom: 15px; }

        label {
            display: block;
            font-size: 11px;
            color: #222;
            margin-bottom: 5px;
        }

        select, button, input[type=file] {
            width: 100%;
            padding: 8px;
            background: #f4f4f4;
            color: #111;
            border: 1px solid #d1d1d1;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 5px;
        }

        button:hover { background: #e8e8e8; }
        button.active { background: #00cc44; color: black; font-weight: bold; }

        input[type=range] {
            width: 100%;
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            border-radius: 999px;
            background: #4a4a4a;
            --fill: 50%;
        }

        input[type=range]::-webkit-slider-runnable-track {
            height: 6px;
            border-radius: 999px;
            background: linear-gradient(
                to right,
                #ff8c1a 0%,
                #ff8c1a var(--fill),
                #4a4a4a var(--fill),
                #4a4a4a 100%
            );
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #ff8c1a;
            margin-top: -4px;
            border: none;
        }

        input[type=range]::-moz-range-track {
            height: 6px;
            border-radius: 999px;
            background: #4a4a4a;
        }

        input[type=range]::-moz-range-progress {
            height: 6px;
            border-radius: 999px;
            background: #ff8c1a;
        }

        input[type=range]::-moz-range-thumb {
            width: 14px;
            height: 14px;
            border: none;
            border-radius: 50%;
            background: #ff8c1a;
        }

        #btn-filters {
            background: #efefef;
            margin-bottom: 0;
        }

        #filter-panel {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: max-height 0.25s ease, opacity 0.25s ease;
            margin-top: 8px;
        }

        #filter-panel.open {
            max-height: 380px;
            opacity: 1;
        }

        #drop-zone, #video-drop-zone {
            border: 1px dashed #b8b8b8;
            padding: 12px;
            text-align: center;
            font-size: 11px;
            color: #333;
            border-radius: 4px;
        }

        #drop-zone.dragover, #video-drop-zone.dragover {
            background: rgba(0, 204, 68, 0.15);
            border-color: #00cc44;
            color: #00cc44;
        }

        .note {
            font-size: 10px;
            color: #333;
            font-style: italic;
            line-height: 1.3;
            margin-top: 10px;
        }
    </style>
</head>
<body>

<div id="ui-panel">
    <h3>Depth Engine</h3>
    <h3> Idea + Prototype by Darius Desir 
        Engineered + Deployed by ALall
        Beta
    </h3>

    <div class="control-group">
        <label>VIDEO SOURCE</label>
        <select id="cameraSelect">
            <option value="" disabled selected>Loading cameras...</option>
        </select>
        <button id="btn-refresh">Refresh List</button>
    </div>

    <div class="control-group">
        <label>IMAGE SOURCE</label>
        <input type="file" id="imageInput" accept="image/*">
        <div id="drop-zone">Drop depth image here</div>
    </div>

    <div class="control-group">
        <label>VIDEO FILE SOURCE (MAX 30S)</label>
        <input type="file" id="videoInput" accept="video/*">
        <div id="video-drop-zone">Drop video here (LiDAR)</div>
    </div>

    <div class="control-group">
        <label>INTERPRETATION MODE</label>
        <button id="btn-mode" onclick="toggleMode()">MODE: SIMULATION (LIGHT)</button>
    </div>

    <div class="control-group">
        <label>DEPTH (Z AMPLITUDE)</label>
        <input type="range" id="depth-range" min="0" max="300" value="100">
    </div>

    <div class="control-group">
        <label>CALIBRATION (CONTRAST)</label>
        <input type="range" id="contrast-range" min="0" max="2" step="0.1" value="1.0">
    </div>

    <div class="control-group">
        <button id="btn-filters" type="button">FILTERS ▸</button>
        <div id="filter-panel">
            <label>BRIGHTNESS</label>
            <input type="range" id="brightness-range" min="-1" max="1" step="0.01" value="0">
            <label>CONTRAST</label>
            <input type="range" id="image-contrast-range" min="0" max="3" step="0.01" value="1">
            <label>SATURATION</label>
            <input type="range" id="saturation-range" min="0" max="3" step="0.01" value="1">
            <label>SHARPNESS</label>
            <input type="range" id="sharpness-range" min="0" max="2" step="0.01" value="0">
        </div>
    </div>

    <p class="note">
      
        <br>
        <br>

        To Do: 
        Add Presets + react 

        <br>
        all266@cornell.edu
    </p>
    <button><a href="https://anthonyasc5.github.io/depthenginebyall/">MAIN VERSION
    </button>
    </a>
</div>

<script type="importmap">
{
    "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
    }
}
</script>

<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

const state = {
    isLidarMode: false,
    depthStrength: 100,
    contrast: 1
};

const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
camera.position.set(0, 0, 150);

const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
document.body.appendChild(renderer.domElement);

const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;

/* ---------- VIDEO SETUP ---------- */

const video = document.createElement('video');
video.autoplay = true;
video.muted = true;
video.playsInline = true;
video.volume = 1;

let activeTexture = new THREE.VideoTexture(video);

const cameraSelect = document.getElementById('cameraSelect');
const refreshBtn = document.getElementById('btn-refresh');

async function getCameras() {
    cameraSelect.innerHTML = '<option disabled selected>Select camera...</option>';
    const devices = await navigator.mediaDevices.enumerateDevices();
    devices.filter(d => d.kind === 'videoinput').forEach((device, i) => {
        const opt = document.createElement('option');
        opt.value = device.deviceId;
        opt.text = device.label || `Camera ${i + 1}`;
        cameraSelect.appendChild(opt);
    });
}

async function startStream(deviceId) {
    const stream = await navigator.mediaDevices.getUserMedia({
        video: { deviceId: deviceId ? { exact: deviceId } : undefined }
    });
    video.muted = true;
    video.srcObject = stream;
    video.play().catch(() => {});
    activeTexture = new THREE.VideoTexture(video);
    material.uniforms.uTexture.value = activeTexture;
    video.onloadedmetadata = () => updateTexelSize(video.videoWidth, video.videoHeight);
}

refreshBtn.onclick = getCameras;
cameraSelect.onchange = e => startStream(e.target.value);

getCameras().then(() => startStream());

/* ---------- IMAGE INPUT ---------- */

const imageInput = document.getElementById('imageInput');
const dropZone = document.getElementById('drop-zone');
const videoInput = document.getElementById('videoInput');
const videoDropZone = document.getElementById('video-drop-zone');
const MAX_VIDEO_SECONDS = 30;
let activeObjectUrl = null;

function setTexture(tex) {
    material.uniforms.uTexture.value = tex;
}

function updateTexelSize(width, height) {
    if (!width || !height) return;
    material.uniforms.uTexelSize.value.set(1 / width, 1 / height);
}

function clearActiveObjectUrl() {
    if (activeObjectUrl) {
        URL.revokeObjectURL(activeObjectUrl);
        activeObjectUrl = null;
    }
}

function loadImage(file) {
    if (!file || !file.type.startsWith('image/')) return;
    clearActiveObjectUrl();
    const img = new Image();
    img.onload = () => {
        const tex = new THREE.Texture(img);
        tex.needsUpdate = true;
        setTexture(tex);
        updateTexelSize(img.width, img.height);
    };
    activeObjectUrl = URL.createObjectURL(file);
    img.src = activeObjectUrl;
}

function loadVideoFile(file) {
    if (!file || !file.type.startsWith('video/')) return;
    clearActiveObjectUrl();
    const objectUrl = URL.createObjectURL(file);
    const probe = document.createElement('video');
    probe.preload = 'metadata';
    probe.onloadedmetadata = () => {
        const duration = probe.duration;
        if (!Number.isFinite(duration) || duration > MAX_VIDEO_SECONDS) {
            alert(`Video too long. Max allowed length is ${MAX_VIDEO_SECONDS} seconds.`);
            URL.revokeObjectURL(objectUrl);
            return;
        }

        if (video.srcObject) {
            video.srcObject.getTracks().forEach(track => track.stop());
            video.srcObject = null;
        }

        activeObjectUrl = objectUrl;
        video.loop = true;
        video.muted = false;
        video.volume = 1;
        video.src = activeObjectUrl;
        video.play().catch(() => {
            alert('Click once on the page to enable audio playback.');
        });
        video.onloadedmetadata = () => updateTexelSize(video.videoWidth, video.videoHeight);
        setTexture(new THREE.VideoTexture(video));
    };
    probe.onerror = () => {
        alert('Invalid video file.');
        URL.revokeObjectURL(objectUrl);
    };
    probe.src = objectUrl;
}

imageInput.onchange = e => loadImage(e.target.files[0]);
videoInput.onchange = e => loadVideoFile(e.target.files[0]);

dropZone.ondragover = e => {
    e.preventDefault();
    dropZone.classList.add('dragover');
};

dropZone.ondragleave = () => dropZone.classList.remove('dragover');

dropZone.ondrop = e => {
    e.preventDefault();
    dropZone.classList.remove('dragover');
    loadImage(e.dataTransfer.files[0]);
};

videoDropZone.ondragover = e => {
    e.preventDefault();
    videoDropZone.classList.add('dragover');
};

videoDropZone.ondragleave = () => videoDropZone.classList.remove('dragover');

videoDropZone.ondrop = e => {
    e.preventDefault();
    videoDropZone.classList.remove('dragover');
    loadVideoFile(e.dataTransfer.files[0]);
};

/* ---------- PARTICLES ---------- */

const width = 400, height = 300;
const count = width * height;

const geometry = new THREE.BufferGeometry();
const positions = new Float32Array(count * 3);
const uvs = new Float32Array(count * 2);

for (let i = 0; i < width; i++) {
    for (let j = 0; j < height; j++) {
        const id = i + j * width;
        positions[id * 3] = (i - width / 2) * 0.5;
        positions[id * 3 + 1] = (height / 2 - j) * 0.5;
        positions[id * 3 + 2] = 0;
        uvs[id * 2] = i / width;
        uvs[id * 2 + 1] = 1 - j / height;
    }
}

geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
geometry.setAttribute('uv', new THREE.BufferAttribute(uvs, 2));

const material = new THREE.ShaderMaterial({
    uniforms: {
        uTexture: { value: activeTexture },
        uDepthFactor: { value: 100 },
        uDepthContrast: { value: 1 },
        uLidarMode: { value: 0 },
        uBrightness: { value: 0 },
        uImageContrast: { value: 1 },
        uSaturation: { value: 1 },
        uSharpness: { value: 0 },
        uTexelSize: { value: new THREE.Vector2(1 / width, 1 / height) }
    },
    vertexShader: `
        uniform sampler2D uTexture;
        uniform float uDepthFactor;
        uniform float uDepthContrast;
        uniform float uLidarMode;
        varying vec2 vUv;
        varying float vElevation;

        void main() {
            vUv = uv;
            vec4 c = texture2D(uTexture, uv);
            float luma = dot(c.rgb, vec3(0.299, 0.587, 0.114));
            float fakeDepth = luma * (1.0 - distance(uv, vec2(0.5)));
            float realDepth = (luma - 0.1) * uDepthContrast;
            float depth = mix(fakeDepth, realDepth, uLidarMode);
            vec3 pos = position;
            pos.z += depth * uDepthFactor;
            vElevation = depth;
            gl_Position = projectionMatrix * modelViewMatrix * vec4(pos, 1.0);
            gl_PointSize = depth > 0.05 ? 2.5 : 0.0;
        }
    `,
    fragmentShader: `
        varying vec2 vUv;
        varying float vElevation;
        uniform sampler2D uTexture;
        uniform float uLidarMode;
        uniform float uBrightness;
        uniform float uImageContrast;
        uniform float uSaturation;
        uniform float uSharpness;
        uniform vec2 uTexelSize;

        vec3 applyImageAdjustments(vec2 uv) {
            vec3 center = texture2D(uTexture, uv).rgb;
            vec3 north = texture2D(uTexture, uv + vec2(0.0, uTexelSize.y)).rgb;
            vec3 south = texture2D(uTexture, uv - vec2(0.0, uTexelSize.y)).rgb;
            vec3 east = texture2D(uTexture, uv + vec2(uTexelSize.x, 0.0)).rgb;
            vec3 west = texture2D(uTexture, uv - vec2(uTexelSize.x, 0.0)).rgb;

            vec3 sharpened = center + uSharpness * (center * 4.0 - (north + south + east + west));
            vec3 color = clamp(sharpened + vec3(uBrightness), 0.0, 1.0);
            color = clamp((color - 0.5) * uImageContrast + 0.5, 0.0, 1.0);
            float luma = dot(color, vec3(0.299, 0.587, 0.114));
            color = mix(vec3(luma), color, uSaturation);
            return clamp(color, 0.0, 1.0);
        }

        void main() {
            vec3 base = applyImageAdjustments(vUv);
            vec3 heat = mix(vec3(0,0,1), vec3(1,0,0), vElevation);
            gl_FragColor = vec4(mix(base, heat, uLidarMode * 0.5), 1.0);
        }
    `,
    transparent: true
});

scene.add(new THREE.Points(geometry, material));

window.toggleMode = () => {
    state.isLidarMode = !state.isLidarMode;
    material.uniforms.uLidarMode.value = state.isLidarMode ? 1 : 0;
    const btn = document.getElementById('btn-mode');
    btn.textContent = state.isLidarMode
        ? 'MODE: LIDAR / DEPTH MAP'
        : 'MODE: SIMULATION (LIGHT)';
    btn.classList.toggle('active', state.isLidarMode);
};

document.getElementById('depth-range').oninput = e =>
    material.uniforms.uDepthFactor.value = Number(e.target.value);

document.getElementById('contrast-range').oninput = e =>
    material.uniforms.uDepthContrast.value = Number(e.target.value);

const filterBtn = document.getElementById('btn-filters');
const filterPanel = document.getElementById('filter-panel');

filterBtn.onclick = () => {
    const isOpen = filterPanel.classList.toggle('open');
    filterBtn.textContent = isOpen ? 'FILTERS ▾' : 'FILTERS ▸';
};

document.getElementById('brightness-range').oninput = e =>
    material.uniforms.uBrightness.value = Number(e.target.value);

document.getElementById('image-contrast-range').oninput = e =>
    material.uniforms.uImageContrast.value = Number(e.target.value);

document.getElementById('saturation-range').oninput = e =>
    material.uniforms.uSaturation.value = Number(e.target.value);

document.getElementById('sharpness-range').oninput = e =>
    material.uniforms.uSharpness.value = Number(e.target.value);

function setRangeFill(input) {
    const min = Number(input.min || 0);
    const max = Number(input.max || 100);
    const value = Number(input.value || 0);
    const pct = max > min ? ((value - min) / (max - min)) * 100 : 0;
    input.style.setProperty('--fill', `${pct}%`);
}

const allRanges = document.querySelectorAll('input[type="range"]');
allRanges.forEach(input => {
    setRangeFill(input);
    input.addEventListener('input', () => setRangeFill(input));
});

function animate() {
    requestAnimationFrame(animate);
    controls.update();
    renderer.render(scene, camera);
}
animate();

window.onresize = () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
};
</script>

</body>
</html>
